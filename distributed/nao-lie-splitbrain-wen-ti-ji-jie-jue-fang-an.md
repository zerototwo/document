# è„‘è£‚ï¼ˆSplit-Brainï¼‰é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

## 1. ä»€ä¹ˆæ˜¯è„‘è£‚ï¼ˆSplit-Brainï¼‰

### æ¦‚å¿µ

è„‘è£‚ï¼ˆSplit-Brainï¼‰ æ˜¯æŒ‡ åˆ†å¸ƒå¼ç³»ç»Ÿ åœ¨\*\*ç½‘ç»œåˆ†åŒºï¼ˆNetwork Partitionï¼‰\*\*çš„æƒ…å†µä¸‹ï¼Œå¤šä¸ªèŠ‚ç‚¹è¯¯ä»¥ä¸ºè‡ªå·±æ˜¯ Leaderï¼Œä»è€Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´æˆ–æœåŠ¡æ•…éšœã€‚

### å‘ç”Ÿåœºæ™¯

* ä¸»ä»é›†ç¾¤ï¼ˆLeader-Followerï¼‰ï¼šä¸»èŠ‚ç‚¹ï¼ˆLeaderï¼‰å’Œéƒ¨åˆ†ä»èŠ‚ç‚¹ï¼ˆFollowerï¼‰æ–­å¼€è¿æ¥ï¼Œå¯¼è‡´ä¸¤ä¸ª Leader ç«äº‰ã€‚
* å¯¹ç­‰é›†ç¾¤ï¼ˆPeer-to-Peerï¼‰ï¼šå¤šä¸ªèŠ‚ç‚¹åœ¨ç½‘ç»œåˆ†åŒºåï¼Œå„è‡ªç‹¬ç«‹æ‰§è¡Œå†™æ“ä½œï¼Œå¯¼è‡´æ•°æ®å†²çªã€‚
* é«˜å¯ç”¨ç³»ç»Ÿï¼ˆHAï¼‰ï¼šå¦‚ Redis Sentinelã€Zookeeperã€Raftï¼Œå¦‚æœè„‘è£‚æœªæ­£ç¡®å¤„ç†ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚

### å…¸å‹æ¡ˆä¾‹

* Redis Sentinelï¼šå¤šä¸ª Sentinel åˆ†åŒºï¼Œå¯èƒ½é€‰å‡ºä¸¤ä¸ª Masterï¼Œå¯¼è‡´æ•°æ®å†²çªã€‚
* Kafkaï¼šå¤šä¸ª Broker è¯¯è®¤ä¸ºè‡ªå·±æ˜¯ Leaderï¼Œæ¶ˆæ¯ä¸¢å¤±æˆ–é‡å¤ã€‚
* Raftï¼šå¤šä¸ªèŠ‚ç‚¹é€‰å‡ºä¸åŒ Leaderï¼Œæ—¥å¿—ä¸ä¸€è‡´ã€‚

## 2. ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿè„‘è£‚ï¼Ÿ

### ä¸»è¦åŸå› 

| åŸå›      | æè¿°                                   |
| ------ | ------------------------------------ |
| ç½‘ç»œåˆ†åŒº   | éƒ¨åˆ†èŠ‚ç‚¹å› ç½‘ç»œæ•…éšœæ–­å¼€ï¼Œä½†ä»ç»§ç»­å·¥ä½œ                   |
| é€‰ä¸¾æœºåˆ¶ç¼ºé™· | èŠ‚ç‚¹å¯èƒ½åœ¨æœªè·å¾—é›†ç¾¤å¤šæ•°ç¥¨æ—¶è‡ªè®¤ä¸ºæ˜¯ Leader            |
| èŠ‚ç‚¹è¶…æ—¶è¯¯åˆ¤ | ç”±äºå¿ƒè·³è¶…æ—¶ï¼ŒFollower è¯¯ä»¥ä¸º Leader æŒ‚æ‰ï¼Œä¸»åŠ¨å‘èµ·é€‰ä¸¾ |
| åŒæ­¥è¶…æ—¶   | Leader æ›´æ–°æ•°æ®åï¼Œéƒ¨åˆ† Follower å› ç½‘ç»œåŸå› æœªåŒæ­¥    |

```mermaid
graph TD;
    A[Leader] --|ç½‘ç»œåˆ†åŒº|--> B[Follower 1]
    A --|ç½‘ç»œåˆ†åŒº|--> C[Follower 2]
    B -->|è¯¯ä»¥ä¸º Leader| D[æ–° Leader 1]
    C -->|è¯¯ä»¥ä¸º Leader| E[æ–° Leader 2]
```

### å½±å“

| å½±å“    | åæœ                                  |
| ----- | ----------------------------------- |
| æ•°æ®ä¸ä¸€è‡´ | ä¸åŒ Leader å¤„ç†ä¸åŒè¯·æ±‚ï¼Œæ•°æ®å†²çª               |
| æ•°æ®ä¸¢å¤±  | è„‘è£‚æ¢å¤åï¼Œæ—§ Leader è¦†ç›–æ–° Leader æ•°æ®ï¼Œå¯¼è‡´æ•°æ®ä¸¢å¤± |
| å®¢æˆ·ç«¯å¼‚å¸¸ | ä¸åŒ Leader è¿”å›ä¸åŒç»“æœï¼Œä¸šåŠ¡é€»è¾‘æ··ä¹±             |

## 3. è„‘è£‚çš„è§£å†³æ–¹æ¡ˆ

é’ˆå¯¹ä¸åŒç³»ç»Ÿå’Œæ¶æ„ï¼Œè„‘è£‚çš„è§£å†³æ–¹æ¡ˆä¸»è¦åŒ…æ‹¬ï¼š

* ä»²è£æœºåˆ¶ï¼ˆQuorumï¼‰
* ç§Ÿçº¦ï¼ˆLease-Based Heartbeatï¼‰
* Fencing Tokenï¼ˆäº‹åŠ¡ä»¤ç‰Œï¼‰
* å¼ºåˆ¶ä¸‹çº¿ï¼ˆSTONITHï¼‰
* åŸºäºæ—¶é’Ÿçš„å†²çªè§£å†³

### æ–¹æ¡ˆ 1ï¼šä»²è£æœºåˆ¶ï¼ˆQuorum Majority Ruleï¼‰

é€‚ç”¨ç³»ç»Ÿ

* Raftï¼ˆETCDã€TiDBï¼‰
* Kafka
* Zookeeper

æ–¹æ¡ˆåŸç†

* é›†ç¾¤åªæœ‰è·å¾— â€œå¤šæ•°æ´¾â€ï¼ˆQuorum Majorityï¼‰çš„èŠ‚ç‚¹æ‰èƒ½æˆä¸º Leaderã€‚
* å°‘æ•°èŠ‚ç‚¹å³ä½¿è¯¯è®¤ä¸ºè‡ªå·±æ˜¯ Leaderï¼Œä¹Ÿæ— æ³•å†™å…¥æ•°æ®ã€‚

```mermaid
graph TD;
    A[Node 1] -->|ç½‘ç»œåˆ†åŒº| B[Node 2]
    A -->|ç½‘ç»œåˆ†åŒº| C[Node 3]
    B -->|è·å¾—è¿‡åŠé€‰ç¥¨| D[æ–° Leader]
    C -->|æœªè·è¿‡åŠæ•°| E[ä¿æŒ Follower]
```



ä»£ç ç¤ºä¾‹ï¼ˆRaftï¼‰

```java
// é€‰ä¸¾æ—¶ï¼Œå¿…é¡»è·å¾—è¿‡åŠæ•°èŠ‚ç‚¹æŠ•ç¥¨
if (votes > totalNodes / 2) {
    becomeLeader();
} else {
    remainFollower();
}
```

å…³é”®ç‚¹

* é˜²æ­¢å°éƒ¨åˆ†èŠ‚ç‚¹å½¢æˆâ€œå­¤ç«‹ç¾¤ä½“â€ã€‚
* å°‘æ•°æ´¾å³ä½¿è¯¯è®¤ä¸º Leaderï¼Œä¹Ÿæ— æ³•æ“ä½œæ•°æ®ã€‚

### æ–¹æ¡ˆ 2ï¼šç§Ÿçº¦æœºåˆ¶ï¼ˆLease-Based Heartbeatï¼‰

é€‚ç”¨ç³»ç»Ÿ

* ETCDã€Zookeeper
* Kubernetes Leader é€‰ä¸¾
* Redis Sentinel

æ–¹æ¡ˆåŸç†

* Leader å®šæœŸå‘ Follower å‘é€ â€œç§Ÿçº¦â€ï¼Œä¿æŒ Leader èº«ä»½ã€‚
* ç§Ÿçº¦è¶…æ—¶åï¼ŒFollower æ‰èƒ½å‘èµ·é€‰ä¸¾ï¼Œé˜²æ­¢è¯¯é€‰ Leaderã€‚

```mermaid
sequenceDiagram
    participant Leader
    participant Follower 1
    participant Follower 2
    Leader ->> Follower 1: å‘é€ Leaseï¼ˆå­˜æ´»ä¿¡å·ï¼‰
    Leader ->> Follower 2: å‘é€ Leaseï¼ˆå­˜æ´»ä¿¡å·ï¼‰
    alt Leader å¤±è”
        Follower 1 ->> New Leader: é€‰ä¸¾æ–°çš„ Leader
    end
```



ä»£ç ç¤ºä¾‹

```java
// åªæœ‰ç§Ÿçº¦ä»ç„¶æœ‰æ•ˆï¼ŒLeader æ‰èƒ½æ‰§è¡Œå†™æ“ä½œ
if (leaseValid()) {
    processWrite();
} else {
    rejectRequest();
}
```

å…³é”®ç‚¹

* é˜²æ­¢çŸ­æš‚ç½‘ç»œæ³¢åŠ¨å¯¼è‡´é”™è¯¯é€‰ä¸¾ã€‚
* ä½¿ç”¨ NTP ä¿æŒæ—¶é—´åŒæ­¥ï¼Œç¡®ä¿ç§Ÿçº¦å‡†ç¡®ã€‚

### æ–¹æ¡ˆ 3ï¼šFencing Tokenï¼ˆäº‹åŠ¡ä»¤ç‰Œï¼‰

é€‚ç”¨ç³»ç»Ÿ

* Zookeeper
* åˆ†å¸ƒå¼æ•°æ®åº“

æ–¹æ¡ˆåŸç†

* Leader é€‰ä¸¾åï¼Œåˆ†é…ä¸€ä¸ªé€’å¢çš„ tokenï¼ˆå¦‚ term IDï¼‰ã€‚
* Follower åªèƒ½æ¥å—æ¯”å½“å‰ token æ›´æ–°çš„ Leaderï¼Œé˜²æ­¢æ—§ Leader ç»§ç»­å†™å…¥ã€‚

```mermaid
graph TD;
    A[Old Leader token=5] -->|å¤±å»è¿æ¥| B[Follower]
    B -->|é€‰ä¸¾æ–° Leader| C[New Leader token=6]
    A -->|å°è¯•å†™å…¥æ•°æ®| D[æ‹’ç»è¯·æ±‚]
```



ä»£ç ç¤ºä¾‹

```java
if (currentTerm < latestTerm) {
    rejectWrite();  // æ—§ Leader æ— æƒå†™å…¥
}
```

å…³é”®ç‚¹

* æ—§ Leader å³ä½¿æ¢å¤ï¼Œä¹Ÿæ— æ³•è¦†ç›–æ–°æ•°æ®ã€‚
* é€‚ç”¨äºåˆ†å¸ƒå¼æ•°æ®åº“ï¼Œå¦‚ MySQL Group Replicationã€‚

## æ–¹æ¡ˆ 4ï¼šSTONITHï¼ˆShoot The Other Node In The Headï¼‰

é€‚ç”¨ç³»ç»Ÿ

* Kubernetes + Etcd
* Ceph
* Redis Sentinel

æ–¹æ¡ˆåŸç†

* ä¸»åŠ¨æ€æ­»æ—§ Leaderï¼Œé˜²æ­¢å…¶ç»§ç»­å·¥ä½œã€‚

```mermaid
graph TD;
    A[Leader] --|ç½‘ç»œåˆ†åŒº|--> B[Follower]
    B -->|è¯¯é€‰ Leader| C[New Leader]
    C -->|æ£€æµ‹åˆ°è„‘è£‚ï¼Œæ‰§è¡Œ STONITH| D[Kill Old Leader]
```



ä»£ç ç¤ºä¾‹ï¼ˆKubernetesï¼‰

```sh
kubectl delete pod etcd-1  # å¼ºåˆ¶æ¸…ç†æ—§ Leader
```

å…³é”®ç‚¹

* é€‚ç”¨äºåˆ†å¸ƒå¼å­˜å‚¨ï¼Œé¿å…æ•°æ®å†²çªã€‚

## 4. å„åˆ†å¸ƒå¼ç³»ç»Ÿå¦‚ä½•è§£å†³è„‘è£‚

| ç³»ç»Ÿ                | æ–¹æ¡ˆ                    | æœºåˆ¶              |
| ----------------- | --------------------- | --------------- |
| Raftï¼ˆETCD, TiDBï¼‰  | ä»²è£æœºåˆ¶                  | åŠæ•°æ´¾é€‰ä¸¾           |
| Zookeeper         | Fencing Token         | äº‹åŠ¡ä»¤ç‰Œ            |
| Redis Sentinel    | Lease-Based Heartbeat | ç§Ÿçº¦              |
| Kafka             | ISRï¼ˆåŒæ­¥å‰¯æœ¬é›†ï¼‰            | Quorum Majority |
| Kubernetes + Etcd | STONITH               | æ€æ­»æ—§ Leader      |

## 5. æ€»ç»“

ğŸ”¹ è„‘è£‚ä¸»è¦ç”±ç½‘ç»œåˆ†åŒºå¯¼è‡´ï¼Œå¤šä¸ª Leader å¯èƒ½å¹¶å­˜ï¼Œé€ æˆæ•°æ®å†²çªã€‚

ğŸ”¹ Raft é‡‡ç”¨ Quorum é€‰ä¸¾æœºåˆ¶ï¼Œç¡®ä¿åªæœ‰ä¸€ä¸ª Leaderã€‚

ğŸ”¹ Zookeeper é‡‡ç”¨ Fencing Tokenï¼Œé˜²æ­¢æ—§ Leader ç»§ç»­å†™å…¥ã€‚

ğŸ”¹ Redis Sentinel é‡‡ç”¨ç§Ÿçº¦æœºåˆ¶ï¼Œç¡®ä¿ Leader é€‰ä¸¾ç¨³å®šã€‚

ğŸ”¹ Kubernetes + Etcd é‡‡ç”¨ STONITHï¼Œç›´æ¥å¼ºåˆ¶æ€æ­»æ—§ Leaderã€‚

\


âœ… ä¸åŒç³»ç»Ÿé‡‡ç”¨ä¸åŒç­–ç•¥ï¼Œé˜²æ­¢è„‘è£‚å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ ğŸš€ã€‚

# 撮合之前的操作



***

## ✅ 撮合交易后的

## 系统级完整流程总结

\


> 目标：确保撮合成功的交易，能正确触发一系列资产更新、日志记录、推送、市场更新、异步协作、合规审计，形成完整的交易闭环。

***

### 🧩 撮合后的全流程：共&#x20;

### 9 大步骤

| 步骤 | 操作模块           | 说明                                    | 是否必须      |
| -- | -------------- | ------------------------------------- | --------- |
| ①  | 撮合输出（TradeLog） | 撮合线程产生成交记录，包含买卖订单ID、数量、价格、时间戳         | ✅ 必须      |
| ②  | 更新订单状态         | 设置订单为：部分成交/全部成交/移除挂单                  | ✅ 必须      |
| ③  | 调整账户资产         | 买卖双方账户：冻结扣减 + 余额增加                    | ✅ 必须      |
| ④  | 写入交易日志         | TradeLog 写入数据库（MySQL/Mongo）或 Kafka    | ✅ 必须      |
| ⑤  | 推送成交消息         | Redis Pub/Sub / Kafka 通知 WebSocket 模块 | ✅ 必须      |
| ⑥  | 更新行情数据         | 更新 ticker、depth、KLine（K线）数据           | ✅ 推荐      |
| ⑦  | 清算模块入账         | Kafka -> 资金系统（划拨记录/结算报表）              | ⚠️ 可选（异步） |
| ⑧  | 风控审计           | 校验用户身份/限额/刷量/异常行为报警                   | ⚠️ 可选（异步） |
| ⑨  | 回执/对账/补发       | 失败记录、Kafka offset 跟踪、数据库对账重发          | ✅ 推荐      |

***

### 🧠 图解说明（补全文字描述）

\


你可以参考下图（你已生成的流程图），它表示从撮合引擎 ➝ 清算 ➝ 推送 的流程：

```
          [撮合线程（核心）]
                  │
     ┌────────────┴────────────┐
     ↓                         ↓
[订单状态更新]         [账户资产调整（原子操作）]
     ↓                         ↓
[TradeLog 生成] ───────────────┐
     ↓                        │
[写入DB 或 Kafka]             │
     ↓                        │
[行情服务]（更新 ticker/K线） │
     ↓                        │
[WebSocket 推送模块] <───── Kafka / Redis Pub/Sub
     ↓
[用户前端展示]
```

***

### 🛠 各模块职责详解（系统分层视角）

\


#### 🔹 撮合引擎（MatchingEngine）

* 匹配买卖订单
* 输出 TradeLog（撮合结果）
* 更新订单簿：移除、部分成交标记
* 不负责写数据库、不负责 WebSocket 推送（解耦）

\


#### 🔹 账户账本服务（BalanceService）

* 扣除买方冻结资产
* 增加买方现货持仓
* 卖方释放冻结资产
* 写入资产变更日志（资产流水）

\


#### 🔹 交易日志服务（TradeLogService）

* TradeLog 落库（MySQL/Mongo）
* 支持异步批量写（提高性能）

\


#### 🔹 推送服务（PushService）

* Kafka / Redis Stream 订阅 TradeEvent
* 转发给 WebSocket 网关
* 用户界面实时看到“订单成交”、“价格变化”

\


#### 🔹 行情服务（MarketService）

* 维护 ticker（涨跌）、depth（盘口）、KLine（分时图）
* 将行情变化发送至外部 WebSocket / REST 接口

\


#### 🔹 清算服务（Settlement）

* 以 Kafka 为输入，批量汇总 TradeLog
* 生成每日报表 / 资金划拨记录

\


#### 🔹 风控服务（RiskControl）

* 检查交易行为
* 识别爆仓、异常下单、限额突破
* 发出警告或拒绝进一步交易

***

### 📦 推送与持久化推荐技术栈

| 功能   | 推荐实现                                | 特性                  |
| ---- | ----------------------------------- | ------------------- |
| 日志落盘 | MySQL / MongoDB                     | 持久、安全               |
| 异步推送 | Kafka                               | 高吞吐、持久、可重试          |
| 实时通知 | Redis Pub/Sub                       | 快速、不可靠（配合 Kafka 补偿） |
| 补偿机制 | Kafka Offset 或 Redis Stream Pending | 可查漏补发               |

***

### ✅ 数据一致性处理建议

| 场景              | 建议                 |
| --------------- | ------------------ |
| 撮合成功但余额更新失败     | 回滚撮合（撤销 TradeLog）  |
| 撮合成功、资产更新成功但未推送 | 补推机制（Kafka Offset） |
| 撮合线程重启          | 未结订单重新装入内存订单簿，支持幂等 |

***

### ✅ 最终总结（你可以拿去团队对接用）

\


> 撮合成功只是交易的“物理发生”，系统要完成完整的一笔交易，还需：

1. > 状态更新
2. > 资产划转
3. > 日志落盘
4. > 实时推送
5. > 行情刷新
6. > 后台清算
7. > 审计风控
8. > 补偿容灾
9. > 完整回溯支持

> \
>

> 这些构成了一个高可靠、面向金融系统的完整撮合交易处理链路。

***


# redis åˆ†å¸ƒå¼é”å¼

å¥½çš„ï¼Œè¿™é‡Œæ˜¯Redis å®ç°åˆ†å¸ƒå¼é”çš„å®Œæ•´æ•´ç†ç‰ˆï¼Œæ¶µç›– é”çš„åŸç†ã€å‡ ç§å®ç°æ–¹å¼ã€æ¯”è¾ƒåˆ†æã€æœ€ä½³å®è·µä¸æ¨èï¼Œå¹¶é…å›¾å¸®åŠ©ç†è§£ã€‚

***

### ğŸ§  ä¸€ã€ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”ï¼Ÿ

\


åˆ†å¸ƒå¼é”ç”¨äºåè°ƒå¤šä¸ªè¿›ç¨‹æˆ–ç³»ç»Ÿå®ä¾‹å¯¹å…±äº«èµ„æºçš„å¹¶å‘è®¿é—®ã€‚

ç‰¹ç‚¹åŒ…æ‹¬ï¼š

* äº’æ–¥æ€§ï¼šåŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½è·å–é”ã€‚
* é¿å…æ­»é”ï¼šé”ä¸èƒ½æ°¸ä¹…å ç”¨ï¼Œå¿…é¡»æœ‰è¶…æ—¶æœºåˆ¶ã€‚
* å¯é‡å…¥æ€§ï¼ˆå¯é€‰ï¼‰ï¼šåŒä¸€ä¸ªå®¢æˆ·ç«¯å¯ä»¥å¤šæ¬¡è·å¾—é”ã€‚
* é«˜å¯ç”¨æ€§ï¼šç³»ç»Ÿå´©æºƒåé”èƒ½è‡ªåŠ¨é‡Šæ”¾ã€‚

***

### ğŸ§° äºŒã€Redis å®ç°åˆ†å¸ƒå¼é”çš„å¸¸è§æ–¹å¼

| å®ç°æ–¹å¼           | åŸå­æ€§ | è‡ªåŠ¨è¿‡æœŸ   | å®‰å…¨è§£é”   | é«˜å¯ç”¨æ€§   | æ¨èç­‰çº§     |
| -------------- | --- | ------ | ------ | ------ | -------- |
| SETNX + EXPIRE | âŒ   | âœ…ï¼ˆéåŸå­ï¼‰ | âŒ      | âŒ      | â­ï¼ˆä¸æ¨èï¼‰   |
| SET NX PXï¼ˆæ¨èï¼‰  | âœ…   | âœ…      | âœ…ï¼ˆLuaï¼‰ | âŒï¼ˆå•å®ä¾‹ï¼‰ | â­â­â­â­     |
| Redisson       | âœ…   | âœ…ï¼ˆå¯ç»­æœŸï¼‰ | âœ…      | âŒ      | â­â­â­â­â­    |
| Redlockï¼ˆå®˜æ–¹ç®—æ³•ï¼‰  | âœ…   | âœ…      | âœ…      | âœ…ï¼ˆå¤šèŠ‚ç‚¹ï¼‰ | â­â­â­â­ï¼ˆå¤æ‚ï¼‰ |

***

### ğŸ” ä¸‰ã€å®ç°åŸç†è¯¦è§£

\


#### 1ï¸âƒ£ SETNX + EXPIREï¼ˆè¿‡æ—¶æ–¹æ¡ˆï¼‰

```
if (redis.setnx("lock:order123", uuid)) {
    redis.expire("lock:order123", 10); // è®¾ç½®é”è¶…æ—¶
}
```

**âŒ é—®é¢˜**

* setnx å’Œ expire éåŸå­ï¼šsetnx æˆåŠŸä½†ç¨‹åº crash ä¼šé€ æˆæ­»é”ã€‚
* æ— æ³•å®‰å…¨è§£é”ï¼šå¯èƒ½è¯¯åˆ ä»–äººé”ã€‚

***

#### 2ï¸âƒ£ SET NX PXï¼ˆæ¨èåŸºç¡€æ–¹æ¡ˆï¼‰

```
SET lock:order123 uuid NX PX 10000
```

* NXï¼šåªåœ¨ key ä¸å­˜åœ¨æ—¶è®¾ç½®
* PX 10000ï¼šè®¾ç½®é”è¿‡æœŸæ—¶é—´ä¸º 10 ç§’ï¼ˆmsï¼‰
* uuidï¼šæ¯ä¸ªå®¢æˆ·ç«¯å”¯ä¸€æ ‡è¯†ï¼Œç”¨äºè§£é”éªŒè¯

\


**âœ… å®‰å…¨è§£é”ï¼ˆLua è„šæœ¬ï¼‰ï¼š**

```
if redis.call("get", KEYS[1]) == ARGV[1] then
    return redis.call("del", KEYS[1])
else
    return 0
end
```

**ä¼˜ç‚¹ï¼š**

* åŸå­åŠ é”
* è‡ªåŠ¨è¿‡æœŸ
* å¯é˜²è¯¯åˆ 

***

#### 3ï¸âƒ£ Redissonï¼ˆJava é¡¹ç›®é¦–é€‰ï¼‰

\


**æ”¯æŒç‰¹æ€§ï¼š**

* è‡ªåŠ¨ç»­æœŸï¼ˆWatchDogï¼‰
* å¯é‡å…¥é”ã€å…¬å¹³é”ã€è¯»å†™é”ã€çº¢é”
* è‡ªåŠ¨é‡Šæ”¾é”ï¼Œé¿å…æ­»é”

\


**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```
RLock lock = redissonClient.getLock("lock:stock");
lock.lock(); // é»˜è®¤ WatchDog è‡ªåŠ¨ç»­æœŸ
try {
    // æ‰§è¡Œé€»è¾‘
} finally {
    lock.unlock();
}
```

**WatchDog å·¥ä½œæœºåˆ¶ï¼ˆè§ä¸‹å›¾ï¼‰ï¼š**

* åˆå§‹ TTL = 30sï¼ˆé»˜è®¤ï¼‰
* æ¯ 10s è‡ªåŠ¨ç»­æœŸ TTL
* è°ƒç”¨ unlock() å WatchDog åœæ­¢

***

#### 4ï¸âƒ£ Redlockï¼ˆRedis å®˜æ–¹åˆ†å¸ƒå¼é”ï¼‰

\


é€‚ç”¨äºå¤š Redis å®ä¾‹ç¯å¢ƒï¼ˆä¸€èˆ¬ 5 ä¸ªèŠ‚ç‚¹ï¼‰ã€‚

\


**æµç¨‹ï¼š**

1. å‘å¤šä¸ª Redis å®ä¾‹å°è¯• SET NX PX
2. å¦‚æœ N/2 + 1 æˆåŠŸï¼Œåˆ™è®¤ä¸ºåŠ é”æˆåŠŸ
3. è®¾ç½® TTLï¼Œç¡®ä¿åœ¨æ‰€æœ‰ Redis èŠ‚ç‚¹ä¸­ç”Ÿæ•ˆæ—¶é—´ä¸€è‡´
4. è§£é”æ—¶å‘æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ Lua è„šæœ¬

\


**ä¼˜ç‚¹ï¼š**

* æŠµå¾¡å•ä¸ª Redis èŠ‚ç‚¹å®•æœº
* é«˜å¯ç”¨ä¿éšœ

\


**ç¼ºç‚¹ï¼š**

* å®ç°å¤æ‚
* å­˜åœ¨å¯¹æ—¶é’Ÿå’Œç½‘ç»œå»¶è¿Ÿä¾èµ–é—®é¢˜

***

### ğŸ§­ å››ã€æ—¶åºå›¾å¯¹æ¯”ï¼ˆç®€å›¾ï¼‰

\


#### SET NX PX åŸç†å›¾

```
Client â€”â€”> Redis:
  SET lock_key uuid NX PX 10000  âœ…

Client â€”â€”> Lua:
  if get(lock_key) == uuid:
     del(lock_key)
```

***

#### Redisson WatchDog åŸç†å›¾

```
æ—¶é—´è½´ â†’
|-- åŠ é”ï¼ˆTTL=30sï¼‰ --|-- 10s å WatchDog ç»­æœŸ --|-- ...ç›´åˆ° unlock() --|
```

***

### âœ… äº”ã€æœ€ä½³å®è·µå»ºè®®

| ä½¿ç”¨åœºæ™¯               | æ¨èæ–¹æ¡ˆ                 |
| ------------------ | -------------------- |
| å•æœº Redis + Java é¡¹ç›® | Redisson             |
| å¤šæœåŠ¡èŠ‚ç‚¹ï¼Œæ— éœ€å¼ºä¸€è‡´        | SET NX PX + Lua      |
| å¤š Redis èŠ‚ç‚¹éœ€é«˜å¯ç”¨     | Redlockï¼ˆæˆ– ZooKeeperï¼‰ |
| ç²¾å‡†æ§åˆ¶é”é‡Šæ”¾æ—¶é—´          | lock(5, TimeUnit.S)  |
| éœ€è¦åˆ†å¸ƒå¼å…¬å¹³é”/è¯»å†™é”ç­‰      | Redisson             |

***

### ğŸ”§ å…­ã€Redisson å¿«é€Ÿé…ç½®

```
singleServerConfig:
  address: "redis://127.0.0.1:6379"
lockWatchdogTimeout: 30000 # é»˜è®¤é”ç»­æœŸæ—¶é—´
```

Maven ä¾èµ–ï¼š

```
<dependency>
  <groupId>org.redisson</groupId>
  <artifactId>redisson</artifactId>
  <version>3.23.4</version>
</dependency>
```

***

### ğŸ“Œ ä¸ƒã€å°ç»“

| ä¼˜ç‚¹  | Redis å®ç°        |
| --- | --------------- |
| ç®€å•  | SET NX PX + Lua |
| å¼ºå¤§  | Redissonï¼ˆè‡ªåŠ¨ç»­æœŸï¼‰  |
| é«˜å¯ç”¨ | Redlockï¼ˆå¤šèŠ‚ç‚¹ï¼‰    |

***

å¦‚æœä½ éœ€è¦ å°è£…å·¥å…·ç±»ã€Spring Boot Starterã€Redis Redlock å®ç°ä»£ç æ¨¡æ¿ï¼Œæˆ‘å¯ä»¥ç»§ç»­æä¾›ã€‚

æ˜¯å¦éœ€è¦ Java å°è£…ç¤ºä¾‹æˆ– Redisson ä½¿ç”¨æ¨¡æ¿ï¼Ÿ

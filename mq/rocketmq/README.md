---
description: æœ¬æ–‡æ•´ç†äº† RocketMQ é¢è¯•é«˜é¢‘é—®é¢˜ï¼ŒåŒ…æ‹¬ æ¶æ„ã€å­˜å‚¨æœºåˆ¶ã€æ¶ˆæ¯å¯é æ€§ã€äº‹åŠ¡æ¶ˆæ¯ã€å»¶è¿Ÿæ¶ˆæ¯ã€æ¶ˆæ¯é¡ºåºæ€§ã€GCä¼˜åŒ– ç­‰æ ¸å¿ƒè€ƒç‚¹ï¼Œå¹¶é™„è¯¦ç»†è§£æã€‚
---

# RocketMq

## 1. RocketMQ çš„æ¶æ„æ˜¯ä»€ä¹ˆï¼Ÿæ ¸å¿ƒç»„ä»¶æœ‰å“ªäº›ï¼Ÿ

RocketMQ é‡‡ç”¨ åˆ†å¸ƒå¼ã€é«˜å¯ç”¨æ¶æ„ï¼Œä¸»è¦ç”± 4 ä¸ªæ ¸å¿ƒç»„ä»¶ ç»„æˆï¼š

1. Producerï¼ˆç”Ÿäº§è€…ï¼‰ï¼šè´Ÿè´£å‘é€æ¶ˆæ¯åˆ° Brokerã€‚
2. Brokerï¼ˆæ¶ˆæ¯æœåŠ¡å™¨ï¼‰ï¼šå­˜å‚¨æ¶ˆæ¯ï¼Œå¹¶å°†æ¶ˆæ¯æŠ•é€’ç»™æ¶ˆè´¹è€…ã€‚
3. Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰ï¼šä» Broker è®¢é˜…æ¶ˆæ¯å¹¶å¤„ç†ä¸šåŠ¡é€»è¾‘ã€‚
4. NameServerï¼ˆæ³¨å†Œä¸­å¿ƒï¼‰ï¼šç®¡ç† Broker è·¯ç”±ä¿¡æ¯ï¼Œæ”¯æŒ åŠ¨æ€æ‰©å±•ã€‚

```mermaid
graph TD;
    Producer -->|å‘é€æ¶ˆæ¯| NameServer;
    NameServer -->|è·¯ç”±å‘ç°| Broker;
    Broker -->|å­˜å‚¨æ¶ˆæ¯| Consumer;
```



ç‰¹ç‚¹

* Broker é›†ç¾¤ï¼ˆä¸»ä»æ¶æ„ï¼‰ æ”¯æŒ é«˜å¯ç”¨ã€‚
* NameServer è´Ÿè´£è·¯ç”±ç®¡ç†ï¼Œæ”¯æŒ åŠ¨æ€æ‰©å±•ã€‚
* Producer/Consumer éƒ½æ”¯æŒ Push å’Œ Pull æ¨¡å¼ã€‚

## 2. RocketMQ æ¶ˆæ¯å­˜å‚¨æœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿ

RocketMQ ä½¿ç”¨ CommitLog å­˜å‚¨æ¶ˆæ¯ï¼Œé‡‡ç”¨ é¡ºåºå†™ + MappedFile æé«˜æ€§èƒ½ã€‚

### æ¶ˆæ¯å­˜å‚¨ç»“æ„

| ç»„ä»¶           | ä½œç”¨                         |
| ------------ | -------------------------- |
| CommitLog    | æ¶ˆæ¯å­˜å‚¨æ ¸å¿ƒæ–‡ä»¶ï¼Œæ‰€æœ‰æ¶ˆæ¯å…ˆå†™å…¥ CommitLog |
| ConsumeQueue | ç´¢å¼•æ–‡ä»¶ï¼ŒåŠ é€Ÿ Consumer æŸ¥æ‰¾æ¶ˆæ¯      |
| IndexFile    | Hash ç´¢å¼•ï¼Œæ”¯æŒæ¶ˆæ¯æŒ‰ Key æŸ¥è¯¢       |

&#x20;å­˜å‚¨ä¼˜åŒ–

â€¢ é›¶æ‹·è´ï¼ˆZero-Copyï¼‰+ MappedFileï¼Œæå‡ IO æ€§èƒ½ã€‚

â€¢ æ¶ˆæ¯å¼‚æ­¥åˆ·ç›˜ï¼ˆé»˜è®¤ ASYNC\_FLUSHï¼‰ï¼Œæé«˜ååé‡ã€‚

â€¢ æ¶ˆæ¯å­˜å‚¨é‡‡ç”¨ MMAPï¼Œé¿å… PageCache å›æ”¶å½±å“ GCã€‚

```mermaid
graph TD;
    A[Producer] -->|å†™å…¥æ¶ˆæ¯| B[CommitLog]
    B -->|ç”Ÿæˆç´¢å¼•| C[ConsumeQueue]
    C -->|ç´¢å¼•æŸ¥è¯¢| D[Consumer]
```



## 3. RocketMQ å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ï¼Ÿ



RocketMQ é€šè¿‡ ä¸‰å¤§æœºåˆ¶ ä¿è¯æ¶ˆæ¯å¯é æ€§ï¼š

### 1. ç”Ÿäº§ç«¯ï¼ˆProducerï¼‰

* é‡è¯•æœºåˆ¶ï¼šå¤±è´¥å è‡ªåŠ¨é‡è¯•ï¼ˆé»˜è®¤ 2 æ¬¡ï¼‰ã€‚
* åŒæ­¥åˆ·ç›˜æ¨¡å¼ï¼ˆSYNC\_FLUSHï¼‰ï¼šç¡®ä¿æ¶ˆæ¯å†™å…¥ç£ç›˜ã€‚
* äº‹åŠ¡æ¶ˆæ¯ï¼šä¿è¯ åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§ã€‚



### 2. å­˜å‚¨ç«¯ï¼ˆBrokerï¼‰

* ä¸»ä»åŒæ­¥ï¼ˆASYNC\_MASTER / SYNC\_MASTERï¼‰ï¼Œé˜²æ­¢ Broker å®•æœºä¸¢æ•°æ®ã€‚
* CommitLog + Checkpointï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±ã€‚

### 3. æ¶ˆè´¹ç«¯ï¼ˆConsumerï¼‰

* ACK ç¡®è®¤æœºåˆ¶ï¼Œæ¶ˆè´¹å¤±è´¥åæ”¯æŒ é‡è¯•æ¶ˆè´¹ã€‚
* æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDLQï¼‰ï¼Œå¤„ç†æ— æ³•æ¶ˆè´¹çš„æ¶ˆæ¯ã€‚

âœ… å¦‚æœä¸šåŠ¡å¯¹å¯é æ€§è¦æ±‚é«˜ï¼Œæ¨è

```
sendMessageInTransaction() # å¼€å¯äº‹åŠ¡æ¶ˆæ¯
```

âœ… å¦‚æœéœ€è¦å¼ºä¸€è‡´æ€§ï¼Œå»ºè®®

```
brokerRole=SYNC_MASTER # å¯ç”¨åŒæ­¥åˆ·ç›˜
```

## 4. RocketMQ å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§ï¼Ÿ

RocketMQ æä¾› ä¸¤ç§æ–¹å¼ ä¿è¯æ¶ˆæ¯é¡ºåºï¼š

### 1. å…¨å±€é¡ºåºï¼ˆå•é˜Ÿåˆ—æ¨¡å‹ï¼‰

* æ‰€æœ‰æ¶ˆæ¯éƒ½å‘é€åˆ°åŒä¸€ä¸ª Queueï¼Œä¿è¯é¡ºåºæ€§ã€‚
* ç¼ºç‚¹ï¼šååé‡ä½ï¼Œå•ç‚¹ç“¶é¢ˆã€‚

### 2. åˆ†åŒºé¡ºåºï¼ˆåŸºäº MessageQueueï¼‰

* åŒä¸€ä¸ªä¸šåŠ¡ Keyï¼ˆå¦‚è®¢å• IDï¼‰æ€»æ˜¯å‘å¾€åŒä¸€é˜Ÿåˆ—ã€‚
* æ¶ˆè´¹è€…æŒ‰ç…§ FIFO æ–¹å¼æ‹‰å–æ¶ˆæ¯ã€‚

### ç¤ºä¾‹

```java
SendResult sendResult = producer.send(
    new Message("Topic", "Tag", "OrderID_123", "Order Created".getBytes()),
    (mqs, msg, arg) -> mqs.get(Math.abs(arg.hashCode()) % mqs.size()),
    "OrderID_123"
);
```

âœ… é€‚ç”¨äºè®¢å•æ”¯ä»˜ã€åº“å­˜æ›´æ–°ç­‰ä¸šåŠ¡åœºæ™¯ã€‚

## 5. RocketMQ å¦‚ä½•å®ç°å»¶è¿Ÿæ¶ˆæ¯ï¼Ÿ

RocketMQ é€šè¿‡å»¶è¿Ÿçº§åˆ« å®ç° å®šæ—¶æ¶ˆæ¯ï¼š

* æ¶ˆæ¯æŠ•é€’åˆ°ç‰¹æ®Šçš„ DelayQueueã€‚
* è¾¾åˆ°æ—¶é—´åï¼ŒæŠ•é€’åˆ°å®é™…é˜Ÿåˆ—ã€‚

### &#x20;å»¶è¿Ÿçº§åˆ«

| çº§åˆ« | å»¶è¿Ÿæ—¶é—´ |
| -- | ---- |
| 1  | 1s   |
| 2  | 5s   |
| 3  | 10s  |
| 4  | 30s  |
| 5  | 1m   |

### ä»£ç ç¤ºä¾‹

```java
Message message = new Message("Topic", "Delayed message".getBytes());
message.setDelayTimeLevel(3); // å»¶è¿Ÿ 10 ç§’
producer.send(message);
```

âœ… é€‚ç”¨äº è®¢å•æ”¯ä»˜è¶…æ—¶ã€å®šæ—¶ä»»åŠ¡ç­‰åœºæ™¯ã€‚

## 6. RocketMQ å¦‚ä½•å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ

RocketMQ æ”¯æŒäº‹åŠ¡æ¶ˆæ¯ï¼ˆTransactional Messageï¼‰ï¼Œåˆ† ä¸‰æ­¥æ‰§è¡Œï¼š

1. å‘é€åŠæ¶ˆæ¯ï¼ˆPrepare çŠ¶æ€ï¼‰ã€‚
2. æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼ˆå¦‚æ•°æ®åº“æ“ä½œï¼‰ã€‚
3. å›è°ƒ checkTransactionState() ç¡®è®¤äº‹åŠ¡çŠ¶æ€ï¼š

â€¢ æˆåŠŸï¼šæäº¤æ¶ˆæ¯ã€‚

â€¢ å¤±è´¥ï¼šå›æ»šæ¶ˆæ¯ã€‚

```java
TransactionMQProducer producer = new TransactionMQProducer("tx_producer");
producer.setTransactionListener(new TransactionListener() {
    @Override
    public LocalTransactionState executeLocalTransaction(Message msg, Object arg) {
        return LocalTransactionState.COMMIT_MESSAGE;
    }

    @Override
    public LocalTransactionState checkLocalTransaction(MessageExt msg) {
        return LocalTransactionState.COMMIT_MESSAGE;
    }
});
```

âœ… é€‚ç”¨äºé‡‘èæ”¯ä»˜ã€è®¢å•ç³»ç»Ÿï¼Œä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§ã€‚

7\. RocketMQ å¦‚ä½•é¿å…æ¶ˆæ¯å †ç§¯ï¼Ÿ

1\. æ‰©å±• MessageQueue æ•°é‡

* å¢åŠ  Partitionï¼Œæå‡å¹¶å‘èƒ½åŠ›ï¼š

```java
queueNums=8

```

2\. ä½¿ç”¨ PullConsumer ä»£æ›¿ PushConsumer

* æ‰‹åŠ¨æ‹‰å–æ¶ˆæ¯ï¼Œæé«˜æ¶ˆè´¹èƒ½åŠ›ï¼š

```java
consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_LAST_OFFSET);
```

3\. æ¶ˆè´¹è€…å¤šçº¿ç¨‹å¹¶å‘æ¶ˆè´¹

â€¢ è°ƒæ•´ consumeMessageBatchMaxSize æé«˜æ‰¹é‡æ¶ˆè´¹èƒ½åŠ›ï¼š

```java
consumer.setConsumeThreadMax(30);
```

âœ… é€‚ç”¨äºé«˜å¹¶å‘æ¶ˆæ¯æ¶ˆè´¹åœºæ™¯ï¼ˆç”µå•†ã€æ—¥å¿—å¤„ç†ï¼‰ã€‚

## 8. RocketMQ å’Œ Kafkaã€RabbitMQ çš„å¯¹æ¯”

| å¯¹æ¯”é¡¹  | RocketMQ    | Kafka    | RabbitMQ  |
| ---- | ----------- | -------- | --------- |
| ååé‡  | ç™¾ä¸‡çº§ TPS     | ç™¾ä¸‡çº§ TPS  | ä¸‡çº§ TPS    |
| é¡ºåºæ¶ˆæ¯ | âœ… æ”¯æŒ        | âŒ ä¸æ”¯æŒ    | âœ… æ”¯æŒ      |
| äº‹åŠ¡æ¶ˆæ¯ | âœ… æ”¯æŒ        | âŒ ä¸æ”¯æŒ    | âœ… æ”¯æŒ      |
| å»¶è¿Ÿæ¶ˆæ¯ | âœ… æ”¯æŒ        | âŒ ä¸æ”¯æŒ    | âœ… æ”¯æŒ      |
| é€‚ç”¨åœºæ™¯ | åˆ†å¸ƒå¼äº‹åŠ¡ã€é‡‘èã€ç”µå•† | æ—¥å¿—æ”¶é›†ã€æµè®¡ç®— | å¾®æœåŠ¡ã€ä½å»¶è¿Ÿæ¶ˆæ¯ |

âœ… RocketMQ é€‚ç”¨äºåˆ†å¸ƒå¼äº‹åŠ¡ã€é¡ºåºæ¶ˆæ¯ã€é‡‘èæ”¯ä»˜ç­‰é«˜å¯é åœºæ™¯ ğŸš€ã€‚

## 9. ç»“è®º

ğŸ”¹ RocketMQ æä¾›é«˜ååã€ä½å»¶è¿Ÿã€æ”¯æŒäº‹åŠ¡ & å»¶è¿Ÿæ¶ˆæ¯ã€‚

ğŸ”¹ é€‚ç”¨äºç”µå•†ã€é‡‘èæ”¯ä»˜ã€è®¢å•ã€å®šæ—¶ä»»åŠ¡ç­‰é«˜å¯é åœºæ™¯ã€‚

ğŸ”¹ é¢è¯•é‡ç‚¹ï¼šäº‹åŠ¡æ¶ˆæ¯ã€é¡ºåºæ¶ˆæ¯ã€æ¶ˆæ¯å †ç§¯ä¼˜åŒ–ã€GC ä¼˜åŒ–ã€‚ ğŸš€
